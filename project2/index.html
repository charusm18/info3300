
<html><head>
    
      <link href="https://fonts.googleapis.com/css?family=Lato:400,700|Raleway:400,700" rel="stylesheet">
      <script src="https://d3js.org/d3.v6.min.js"></script>
      <script src="https://d3js.org/topojson.v2.min.js"></script>
      <style>
    
      .state {
        fill: lightgrey;
      }
    
      .outline {
        stroke: black;
        stroke-width: 1px;
        fill: none;
      }
      
      .mouseover {
        stroke-width: 3px;
        pointer-events: none;
      }
      .stateBox{
        width: 350px;
        height: 500px;
        padding: 10px;
        border: 5px solid black ;
        margin: 0;
        position: fixed;
        bottom: 10;
        right: 422;
      }
      .countyBox{
        width: 350px;
        height: 500px;
        padding: 10px;
        border: 5px solid black ;
        margin: 0;
        position: fixed;
        bottom: 10;
        right: 40;
      }


      .stateLabel{
        color: black;
        font-size:160%;
        font-weight: bold;
        margin: 0;
      }

      .nation {
    fill: #ddd;
  }

  /* .outline {
    stroke: #fff;
    stroke-width: 1px;
    fill: none;
  } */
    
      </style>
    
    </head>
    <body>
      <div class="container larger">    
    
      <svg id="usmap" height="600" width="900" style="background: #445; margin-top:50px" >
    
      </svg>
    
      <svg id="statemap" height="610" width="975" style="background: #fff; margin-top:50px" >

      </svg>
       <div class ="stateBox">
          <p id = "p1" class = "stateLabel"></p>
         
       </div>
       <div class ="countyBox">
        <p id = "p2" class = "stateLabel"></p>
        <svg id = "pieChart" width = 300 height = 300></svg>
     </div>
  
      <script>
    
      const svg = d3.select("#usmap");
      const width = svg.attr("width");
      const height = svg.attr("height");
      const margin = { top: 20, right: 20, bottom: 20, left:20};
      const mapWidth = width - margin.left - margin.right;
      const mapHeight = height - margin.top - margin.bottom;
      const map = svg.append("g")
                      .attr("transform","translate("+margin.left+","+margin.top+")");

      const statesvg = d3.select("#statemap");
      const stWidth = statesvg.attr("width");
      const stHeight = statesvg.attr("height");;
      const statemap = statesvg.append("g");

                    
      const requestData = async function() {
        
        const fipsCode = await d3.csv("../fips.csv");
        const stateNames = await d3.tsv("../us-state-names.tsv");
        const us = await d3.json("../us-smaller.json");
        const pop = await d3.csv("../PopulationEstimates.csv");
        const crime = await d3.csv("../crime.csv");
        const police = await d3.csv("../police.csv");
        const count = await d3.json("../counties-10m.json");
      
        var states = topojson.feature(us, us.objects.states);
        var statesMesh = topojson.mesh(us, us.objects.states);
        var projection = d3.geoAlbersUsa().fitSize([mapWidth, mapHeight], states);
        var path = d3.geoPath().projection(projection);
        
        map.selectAll("path.state").data(states.features)
           .join("path")
           .attr("class", "state")
           .attr("note", d => d.id)
           .attr("d", path);
      
        map.append("path").datum(statesMesh)
           .attr("class","outline")
           .attr("d", path);

        let idToState = {} 
        stateNames.forEach( row => {
          idToState[row.id] = row.name;
        });

        let stateToCode = {} 
        stateNames.forEach( row => {
          stateToCode[row.name] = row.code;
        });

        let fipsToPop = {} 
        pop.forEach( row => {
          fipsToPop[row.FIPS] = row.POP_2016;
        });

        let fipsToCounty = {} 
        pop.forEach( row => {
          fipsToCounty[row.FIPS] = row.Area_Name;
        });

        let countyToCrime = {} 
        let crimeRange = []
        crime.forEach( row => {
          countyToCrime[parseInt(row.FIPS)] = row.total_crime;
          crimeRange.push(row.total_crime);
        });

      
        let countyToPolice = {} 
        let policeRange = []
        police.forEach( row => {
          countyToPolice[parseInt(row.FIPS)] = row.Total_law/fipsToPop[row.FIPS];
          policeRange.push(row.Total_law/fipsToPop[row.FIPS]);
        });
        console.log(fipsToPop['56021'])

  //------------------------------------------------------------------//    
        var counties = topojson.feature(count, count.objects.counties);
        const countyDictionary = {}
        for(var i = 0; i < stateNames.length; i++){
          countyDictionary[stateNames[i]['code']] =[]
        }
    
        for(var i = 0; i < counties.features.length; i++){
          for(var j = 0; j < fipsCode.length; j++){
            if(fipsCode[j]['STCOUNTYFP'] == parseInt(counties.features[i].id)){
              var newList = countyDictionary[fipsCode[j]['STATE']]
              newList.push(counties.features[i])
              countyDictionary[fipsCode[j]['STATE']] = newList
            }

          }
        }        
  
    d3.selectAll(".state").on("click", displayState);

    let colorMatrix = [ ["#e8e8e8", "#ace4e4", "#5ac8c8"],
                        ["#dfb0d6", "#a5add3", "#5698b9"],
                        ["#be64ac", "#8c62aa", "#3b4994"] ];

    console.log(crimeRange)
    let crimeScale = d3.scaleQuantile().domain(crimeRange).range([0,1,2]);   
    let policingScale = d3.scaleQuantile().domain(policeRange).range([0,1,2]);

     //legend code      
    let legend = statemap.append("g").attr("class","legend")
                     .attr("transform","translate(820,470) rotate(-45)");
    for (let i=0; i<colorMatrix.length; i++) {
     for (let j=0; j<colorMatrix.length; j++) {
       legend.append("rect")
             .attr("x", i*30)
             .attr("y", 60-j*30)
             .attr("width",30)
             .attr("height",30)
             .attr("fill", colorMatrix[i][j]);
      }
    }
    legend.append("text").text("Total Police")
         .attr("text-anchor","middle")
         .attr("transform","translate(45,110)")
    legend.append("text").text("Total Crime")
         .attr("text-anchor","middle")
         .attr("transform","translate(-20,45) rotate(90)")
    statesvg.append('defs').append('marker').attr('id', 'arrowhead')
        .attr('viewBox', [0, 0, 6, 6])
        .attr('refX', 0).attr('refY', 3)
        .attr('markerWidth', 6).attr('markerHeight', 6)
        .attr('orient', 'auto-start-reverse')
        .append('path')
        .attr('d', d3.line()([[0, 0], [0, 6], [6, 3]]))
        .attr('fill', 'black');
    // Arrow lines
    legend.append("path")
          .attr('marker-start', 'url(#arrowhead)')
          .attr('marker-end', 'url(#arrowhead)')
          .attr("d", d3.line()([[65,90],[0,90],[0,25]]))
          .attr("fill","none")
          .attr("stroke-width", 2)
          .attr('stroke', 'black');
    // --- End legend code
  
    function displayState() {
      let state = d3.select(this);
      let stateID = state.datum().id;
      var stateAbr = stateToCode[idToState[stateID]];
      var stateName = idToState[stateID]
      console.log(stateAbr)
      
  
      var projection = d3.geoMercator().fitSize([stWidth, stHeight], {type: "FeatureCollection", features: countyDictionary[stateAbr]});
      var path = d3.geoPath().projection(projection);
      statemap.selectAll("path.county").data(countyDictionary[stateAbr])
            .join("path")
            .attr("class","county")
            .attr("d", path)
            .attr("fill", d => { 
              console.log(countyToPolice[parseInt(d.id)]);
                  let crimeIndex = crimeScale(countyToCrime[parseInt(d.id)]);
                  let policeIndex = policingScale(countyToPolice[parseInt(d.id)]);
                  console.log(crimeIndex, policeIndex)

                  if (crimeIndex === undefined | policeIndex === undefined) {
                      return "grey";  // No fill
                  }
                  else {
                    return colorMatrix[crimeIndex][policeIndex];
                  }
            });

      
      d3.selectAll(".county").on("click", countyHover);

      //determines what to do when you click on a county
      function countyHover() {
        let county = d3.select(this);
        let fipsID = county.datum().id;
        
        d3.select("#p2").text(fipsToCounty[parseInt(fipsID)])
        console.log(fipsToCounty[parseInt(fipsID)], fipsToPop[fipsID]);

        let data= {}
        crime.forEach( row => {
          crimeRates[parseInt(row.FIPS)] = row.total_crime;
          crimeRange.push(row.total_crime);
        });

        var data = [1.1,2.2,4.46,2.12,1.36,5.002445,4.1242];
        var svgCounty = d3.select("#pieChart");
        let g = svgCounty.append("g")
                .attr("transform", "translate(200,200)");
            
        // Creating Pie generator
        var pie = d3.pie();
        // Creating arc
        var arc = d3.arc()
                    .innerRadius(0)
                    .outerRadius(100);

        // Grouping different arcs
        var arcs = g.selectAll("arc")
                    .data(pie(data))
                    .enter()
                    .append("g");

        // Appending path 
        arcs.append("path")
            .attr("fill", (data, i)=>{
                let value=data.data;
                return d3.schemeSet3[i];
            })
            .attr("d", arc);
      
      }
      d3.select("#p2").text("")
      d3.select("#p1").text(stateName)

      
    }
    
   
      };
      requestData();
    
    
      </script>
     
    

      </div>
    </body>
    </html>
    