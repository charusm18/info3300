
<html><head>
    
      <link href="https://fonts.googleapis.com/css?family=Lato:400,700|Raleway:400,700" rel="stylesheet">
      <script src="https://d3js.org/d3.v6.min.js"></script>
      <script src="https://d3js.org/topojson.v2.min.js"></script>
      <style>
    
      .state {
        fill: lightgrey;
      }
    
      .outline {
        stroke: black;
        stroke-width: 1px;
        fill: none;
      }
      
      .mouseover {
        stroke-width: 3px;
        pointer-events: none;
      }
      .stateBox{
        width: 350px;
        height: 500px;
        padding: 10px;
        border: 5px solid black ;
        margin: 0;
      }
      .countyBox{
        width: 350px;
        height: 500px;
        padding: 10px;
        border: 5px solid black ;
        margin: 0;
      }

      .container{
        margin-top: 50;
        display:flex;
      }
      .infographic{
        display:flex;
        width: auto;
      }

      .stateLabel{
        color: black;
        font-size:160%;
        font-weight: bold;
        margin: 0;
      }

      .nation {
    fill: #ddd;
  }

  /* .outline {
    stroke: #fff;
    stroke-width: 1px;
    fill: none;
  } */
    
      </style>
    
    </head>
    <body>
      <div class= "country_container">
        <svg id="usmap" height="600" width="900" style="background: #445; margin-top:50px" >
        </svg>
      </div>
      
      <div class= "container">
        <div>
          <svg id="statemap" height="610" width="600" style="background: #fff; margin-top:50px" >
          </svg>
        </div>
        <div class="infographic">
          <div class ="stateBox">
            <p id = "p1" class = "stateLabel"></p>
            <svg width="300" height="225" id = "stateBox"></svg>
            <svg width="300" height="225" id = "crimeBox"></svg>
          </div>

          <div class ="countyBox">
            <p id = "p2" class = "stateLabel"></p>
            <svg id = "pieChart" width = 500 height = 500></svg>
          </div>
        </div>
      </div>
    </body>
  
    <script>
    
      const svg = d3.select("#usmap");
      const width = svg.attr("width");
      const height = svg.attr("height");
      const margin = { top: 20, right: 20, bottom: 20, left:20};
      const mapWidth = width - margin.left - margin.right;
      const mapHeight = height - margin.top - margin.bottom;
      const map = svg.append("g")
                      .attr("transform","translate("+margin.left+","+margin.top+")");

      const statesvg = d3.select("#statemap");
      const stWidth = statesvg.attr("width");
      const stHeight = statesvg.attr("height");;
      const statemap = statesvg.append("g");

                    
      const requestData = async function() {
        
        const fipsCode = await d3.csv("../fips.csv");
        const pop = await d3.csv("../PopulationEstimates.csv");
        const crime = await d3.csv("../crime.csv");
        const police = await d3.csv("../police.csv");
        const spending = await d3.csv("../police_spending.csv");
        const state_crime = await d3.csv("../state_crime.csv");


        const count = await d3.json("../counties-10m.json");
        const us = await d3.json("../us-smaller.json");

        const stateNames = await d3.tsv("../us-state-names.tsv");

        var states = topojson.feature(us, us.objects.states);
        var statesMesh = topojson.mesh(us, us.objects.states);
        var projection = d3.geoAlbersUsa().fitSize([mapWidth, mapHeight], states);
        var path = d3.geoPath().projection(projection);
        
        map.selectAll("path.state").data(states.features)
           .join("path")
           .attr("class", "state")
           .attr("note", d => d.id)
           .attr("d", path);
      
        map.append("path").datum(statesMesh)
           .attr("class","outline")
           .attr("d", path);

        let idToState = {} 
        stateNames.forEach( row => {
          idToState[row.id] = row.name;
        });

        let stateToCode = {} 
        stateNames.forEach( row => {
          stateToCode[row.name] = row.code;
        });

        let fipsToPop = {} 
        pop.forEach( row => {
          fipsToPop[row.FIPS] = row.POP_2016;
        });

        let fipsToCounty = {} 
        pop.forEach( row => {
          fipsToCounty[row.FIPS] = row.Area_Name;
        });

        let countyToCrime = {} 
        let crimeRange = []
        crime.forEach( row => {
          countyToCrime[parseInt(row.FIPS)] = row.total_crime;
          crimeRange.push(row.total_crime);
        });

        let countyCrimeRates = {} 
        crime.forEach( row => {
          let crimeRates= []
          crimeRates.push(row.Murder/row.total_crime);
          crimeRates.push(row.Rape/row.total_crime);
          crimeRates.push(row.Robbery/row.total_crime);
          crimeRates.push(row.Assault/row.total_crime);
          crimeRates.push(row.Burglary/row.total_crime);
          crimeRates.push(row.Larceny/row.total_crime);
          crimeRates.push(row.Motor/row.total_crime);
          crimeRates.push(row.Arson/row.total_crime);
          countyCrimeRates[parseInt(row.FIPS)] = crimeRates;

        });

      
        let countyToPolice = {} 
        let policeRange = []
        police.forEach( row => {
          countyToPolice[parseInt(row.FIPS)] = row.Total_law/fipsToPop[row.FIPS];
          policeRange.push(row.Total_law/fipsToPop[row.FIPS]);
        });

        let stateToSpending = {} 
        spending.forEach( row => {
          stateToSpending[row.State] = row.Police;
        });

        let stateToCrime = {} 
        state_crime.forEach( row => {
          stateToCrime[row.State] = row.state_rate;
        });
  //------------------------------------------------------------------//    
        var counties = topojson.feature(count, count.objects.counties);
        const countyDictionary = {}
        for(var i = 0; i < stateNames.length; i++){
          countyDictionary[stateNames[i]['code']] =[]
        }
    
        for(var i = 0; i < counties.features.length; i++){
          for(var j = 0; j < fipsCode.length; j++){
            if(fipsCode[j]['STCOUNTYFP'] == parseInt(counties.features[i].id)){
              var newList = countyDictionary[fipsCode[j]['STATE']]
              newList.push(counties.features[i])
              countyDictionary[fipsCode[j]['STATE']] = newList
            }

          }
        }        
  
    let colorMatrix = [ ["#C9D7DC", "#99B1D1", "#5E8CD0"],
                        ["#9CC3B6", "#73A4B4", "#4A82B3"],
                        ["#63B294", "#4E9592", "#377791"] ];

    let crimeScale = d3.scaleQuantile().domain(crimeRange).range([0,1,2]);   
    let policingScale = d3.scaleQuantile().domain(policeRange).range([0,1,2]);

     //legend code      
    let legend = statemap.append("g").attr("class","legend")
                     .attr("transform","translate(10,470) rotate(-45)");
    for (let i=0; i<colorMatrix.length; i++) {
     for (let j=0; j<colorMatrix.length; j++) {
       legend.append("rect")
             .attr("x", i*30)
             .attr("y", 60-j*30)
             .attr("width",30)
             .attr("height",30)
             .attr("fill", colorMatrix[i][j]);
      }
    }
    legend.append("text").text("Total Police")
         .attr("text-anchor","middle")
         .attr("transform","translate(45,110)")
    legend.append("text").text("Total Crime")
         .attr("text-anchor","middle")
         .attr("transform","translate(-20,45) rotate(90)")
    statesvg.append('defs').append('marker').attr('id', 'arrowhead')
        .attr('viewBox', [0, 0, 6, 6])
        .attr('refX', 0).attr('refY', 3)
        .attr('markerWidth', 6).attr('markerHeight', 6)
        .attr('orient', 'auto-start-reverse')
        .append('path')
        .attr('d', d3.line()([[0, 0], [0, 6], [6, 3]]))
        .attr('fill', 'black');
    // Arrow lines
    legend.append("path")
          .attr('marker-start', 'url(#arrowhead)')
          .attr('marker-end', 'url(#arrowhead)')
          .attr("d", d3.line()([[65,90],[0,90],[0,25]]))
          .attr("fill","none")
          .attr("stroke-width", 2)
          .attr('stroke', 'black');
    // --- End legend code
  
    d3.selectAll(".state").on("click", displayState);
    d3.selectAll(".state").on("mouseenter", stateHover);
    d3.selectAll(".state").on("mouseout",  stateExit);

    function stateHover(){
      let state = d3.select(this);      
      state.attr("stroke","black")
           .attr("stroke-width", 3);
    }
    function stateExit(){
      let state = d3.select(this);
      state.attr("stroke","none")
          .attr("stroke-width", 0);
    }
    function displayState() {
      let state = d3.select(this);
      let stateID = state.datum().id;
      var stateAbr = stateToCode[idToState[stateID]];
      var stateName = idToState[stateID]
      
  
      var projection = d3.geoMercator().fitSize([stWidth-200, stHeight-200], {type: "FeatureCollection", features: countyDictionary[stateAbr]});
      var path = d3.geoPath().projection(projection);
      statemap.selectAll("path.county").data(countyDictionary[stateAbr])
            .join("path")
            .attr("class","county")
            .attr("stroke","white")
            .attr("stroke-width", 1)
            .attr("d", path)
            .attr("fill", d => { 
                  let crimeIndex = crimeScale(countyToCrime[parseInt(d.id)]);
                  let policeIndex = policingScale(countyToPolice[parseInt(d.id)]);

                  if (crimeIndex === undefined | policeIndex === undefined) {
                      return "#878787";  // No fill
                  }
                  else {
                    return colorMatrix[crimeIndex][policeIndex];
                  }
            });

      
      d3.selectAll(".county").on("click", countyClick);
      d3.selectAll(".county").on("mouseenter", countyHover);
      d3.selectAll(".county").on("mouseout",  countyExit);
      
      let valueExtent = d3.extent(crime, d => d.total_crime);
      let colorScale = d3.scaleSequential(d3.interpolateViridis).domain(valueExtent)

      //determines what to do when you click on a county
      function countyClick() {
        let county = d3.select(this);
        let fipsID = county.datum().id;
        
        d3.select("#p2").text(fipsToCounty[parseInt(fipsID)])
        console.log(fipsToCounty[parseInt(fipsID)], fipsToPop[fipsID]);

      // PIE CHART
      
      var data= countyCrimeRates[parseInt(fipsID)]
      var svgCounty = d3.select("#pieChart");
      const pieChart = d3.selectAll("svg#pieChart");
      pieChart.selectAll("*").remove();  
      let g = svgCounty.append("g")
              .attr("transform", "translate(100,150)");
      console.log("data: " + data)
      if(data == undefined){
        pieChart.append("text")
                    .attr("class", "x label")
                    .attr("text-anchor", "middle")
                    .attr("x",170)
                    .attr("y",200)
                    .text("This county did not report any crime data for 2016");
      }
      else{
        // Creating Pie generator
      var pie = d3.pie();
      // Creating arc
      var arc = d3.arc()
                  .innerRadius(0)
                  .outerRadius(100);

      // Grouping different arcs
      var arcs = g.selectAll("arc")
                  .data(pie(data))
                  .enter()
                  .append("g");
      var colorScale = d3.scaleOrdinal()
                        .domain(["Murder", "Rape", "Robbery", "Assault", "Burgalry", "Larceny", "Motor", "Arson" ])
                        .range(["#264653", "#2A9D8F", "#E9C46A", "#F4A261", "#E76F51", "#05668D", "#E5989B", "#4A6FA5"]);

      // Appending path 
      let crimeTypes = ["Murder", "Rape", "Robbery", "Assault", "Burgalry", "Larceny", "Motor", "Arson"]
      // let index = 0
      arcs.append("path")
          .attr("fill", (data, i)=>{
            console.log("i: " + i)
            let value=data.data;
            console.log("one step before: " + crimeTypes[i])
            console.log("color: " + colorScale[crimeTypes[i]])
            return colorScale(crimeTypes[i]);

            
          })
          .attr("d", arc);
          
        

          // Add one dot in the legend for each name.
          svgCounty.selectAll("mydots")
            .data(crimeTypes)
            .enter()
            .append("circle")
              .attr("cx", 100)
              .attr("cy", function(d,i){ return 100 + i*25}) // 100 is where the first dot appears. 25 is the distance between dots
              .attr("r", 7)
              .style("fill", function(d){ return colorScale(d)})
              .attr("transform","translate(120,-40)")

          // Add one dot in the legend for each name.
          svgCounty.selectAll("mylabels")
            .data(crimeTypes)
            .enter()
            .append("text")
              .attr("x", 120)
              .attr("y", function(d,i){ return 100 + i*25}) // 100 is where the first dot appears. 25 is the distance between dots
              .style("fill", function(d){ return colorScale(d)})
              .text(function(d){ return d})
              .attr("text-anchor", "left")
              .style("alignment-baseline", "middle")
              .attr("transform","translate(120,-40)")
       

      }
      
          
      

      }      
      
      function countyHover(){
        let county = d3.select(this);      
        county.attr("stroke","white")
           .attr("stroke-width", 3);

      }

      function countyExit(){
        let county = d3.select(this);      
        county.attr("stroke","white")
           .attr("stroke-width", 1);
      }
      
      
      d3.select("#p2").text("")
      d3.selectAll("svg#pieChart").selectAll("*").remove();
      d3.selectAll("#p1").text(stateName + " Statistics")
      
      var barChart = d3.selectAll("svg#stateBox"),
        margin = 200,
        width = barChart.attr("width")-margin,
        height = barChart.attr("height")-50

      const stateScale = d3.scaleLinear().domain([0, 1]).range([margin, width]);
      const spendingScale = d3.scaleLinear().domain([172,864]).range([height-1,0]);
      barChart.selectAll("*").remove();     
      barChart.append("line")
                  .attr("x1",stateScale(0) )
                  .attr("x2",stateScale(0) )
                  .attr("y1",height)
                  .attr("y2",spendingScale(stateToSpending[stateName])) 
                  .style("stroke", '#599065')
                  .style("stroke-width", 45)
                  .attr("fill", 'grey')
          
      barChart.append("line")
                  .attr("x1",stateScale(1)) //50 accounts for the padding
                  .attr("x2",stateScale(1))
                  .attr("y1",height)
                  .attr("y2",spendingScale(stateToSpending['United States'] )) 
                  .style("stroke", '#599065')
                  .style("stroke-width", 45)
                  .attr("fill",'grey')

      barChart.append("text")
                    .attr("class", "x label")
                    .attr("text-anchor", "middle")
                    .attr("x", stateScale(0))
                    .attr("y", height + 20)
                    .text(stateToCode[stateName]);

      barChart.append("text")
                    .attr("class", "x label")
                    .attr("text-anchor", "middle")
                    .attr("x", stateScale(1))
                    .attr("y", height + 20)
                    .text("US");

        //for each bar, create a label on top of bar with percentage for 2010
        barChart.append("text")
                  .attr("text-anchor","middle")
                  .attr("font-size","20px")
                  .attr("x",stateScale(0))
                  .attr('y',spendingScale(stateToSpending[stateName]) - 10)
                  .text("$"+stateToSpending[stateName]+' K');
          
        //for each bar, create a label on top of bar with percentage for 2019
        barChart.append("text")
                  .attr("text-anchor","middle")
                  .attr("font-size","20px")
                  .attr("x",stateScale(1))
                  .attr('y',spendingScale(stateToSpending['United States'] ) - 10)
                  .text("$"+stateToSpending['United States']+' K');

          let leftAxis = d3.axisLeft(spendingScale).ticks(5).tickSizeOuter(0);
          barChart.append("g")
            .attr("class", "y axis")
            .attr("transform","translate("+(margin-width-50)+","+(margin-width-100)+")") 
            .call(leftAxis);

          let bottomAxis = d3.axisBottom(stateScale).tickValues([])
                            .tickSizeOuter(0)
          // d3.barChart.axis().outerTickSize(0);

          let element = barChart.append("g")
                          .attr("class", "x axis")
                          .attr("transform","translate("+(margin-height-75)+","+(margin-25)+")")
                          
          bottomAxis(element);
          let bottomAxis2 = d3.axisBottom(stateScale).tickValues([]);
          let element2 = barChart.append("g")
                          .attr("class", "x axis")
                          .attr("transform","translate("+(margin-height+25)+","+(margin-25)+")")
                          
          bottomAxis(element2);

      var crimeChart = d3.selectAll("svg#crimeBox"),
        margin = 200,
        width2 = barChart.attr("width")-margin,
        height2 = barChart.attr("height")-50
      const crimeStateScale = d3.scaleLinear().domain([3452.8, 12076.5]).range([height2-1,0]);

      crimeChart.selectAll("*").remove();     
      crimeChart.append("line")
                  .attr("x1",stateScale(0) )
                  .attr("x2",stateScale(0) )
                  .attr("y1",height2)
                  .attr("y2",crimeStateScale(stateToCrime[stateName])) 
                  .style("stroke", '#DC8471')
                  .style("stroke-width", 45)
                  .attr("fill", 'grey')
          
      crimeChart.append("line")
                  .attr("x1",stateScale(1))
                  .attr("x2",stateScale(1))
                  .attr("y1",height2)
                  .attr("y2",crimeStateScale(stateToCrime['United States'] )) 
                  .style("stroke", '#DC8471')
                  .style("stroke-width", 45)
                  .attr("fill",'grey')

      crimeChart.append("text")
                    .attr("class", "x label")
                    .attr("text-anchor", "middle")
                    .attr("x", stateScale(0))
                    .attr("y", height2 + 20)
                    .text(stateToCode[stateName]);

      crimeChart.append("text")
                    .attr("class", "x label")
                    .attr("text-anchor", "middle")
                    .attr("x", stateScale(1))
                    .attr("y", height2 + 20)
                    .text("US");

        crimeChart.append("text")
                  .attr("text-anchor","middle")
                  .attr("font-size","20px")
                  .attr("x",stateScale(0))
                  .attr('y',crimeStateScale(stateToCrime[stateName]) - 10)
                  .text(stateToCrime[stateName]);
          
        crimeChart.append("text")
                  .attr("text-anchor","middle")
                  .attr("font-size","20px")
                  .attr("x",stateScale(1))
                  .attr('y', crimeStateScale(stateToCrime['United States'] ) - 10)
                  .text(stateToCrime['United States']);   

    }
    
   
      };
      requestData();
    
    
      </script>
     
    

      </div>
    </body>
    </html>
    