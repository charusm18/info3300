
<html><head>
    
      <link href="https://fonts.googleapis.com/css?family=Lato:400,700|Raleway:400,700" rel="stylesheet">
      <script src="https://d3js.org/d3.v6.min.js"></script>
      <script src="https://d3js.org/topojson.v2.min.js"></script>
      <style>
    
      .state {
        fill: lightgrey;
      }
    
      .outline {
        stroke: black;
        stroke-width: 1px;
        fill: none;
      }
      
      .mouseover {
        stroke-width: 3px;
        pointer-events: none;
      }

      .nation {
    fill: #ddd;
  }

  /* .outline {
    stroke: #fff;
    stroke-width: 1px;
    fill: none;
  } */
    
      </style>
    
    </head>
    <body>
      <div class="container larger">    
    
      <svg id="choropleth" height="600" width="900" style="background: #445; margin-top:50px" >
    
      </svg>
    
      <svg id="obesity" height="610" width="975" style="background: #fff; margin-top:50px" >

      </svg>
      <script id="notes1">
    
      const svg = d3.select("#choropleth");
      const width = svg.attr("width");
      const height = svg.attr("height");
      const margin = { top: 20, right: 20, bottom: 20, left:20};
      const mapWidth = width - margin.left - margin.right;
      const mapHeight = height - margin.top - margin.bottom;
      const map = svg.append("g")
                      .attr("transform","translate("+margin.left+","+margin.top+")");

      const obsvg = d3.select("#obesity");
      const obwidth = obsvg.attr("width");
      const obheight = obsvg.attr("height");
      const obmapWidth = obwidth;
      const obmapHeight = obheight;
      const ffmap = obsvg.append("g");

                    
      const requestData = async function() {
        
        const fipsCode = await d3.csv("../fips.csv");
        const stateNames = await d3.tsv("../us-state-names.tsv");
        const us = await d3.json("../us-smaller.json");
        const pop = await d3.csv("../PopulationEstimates.csv");
        const crime = await d3.csv("../crime.csv");
        const police = await d3.csv("../police.csv");
      
        var states = topojson.feature(us, us.objects.states);
        var statesMesh = topojson.mesh(us, us.objects.states);
        var projection = d3.geoAlbersUsa().fitSize([mapWidth, mapHeight], states);
        var path = d3.geoPath().projection(projection);
        
        map.selectAll("path.state").data(states.features)
           .join("path")
           .attr("class", "state")
           .attr("note", d => d.id)
           .attr("d", path);
      
        map.append("path").datum(statesMesh)
           .attr("class","outline")
           .attr("d", path);

        let idToState = {} 
        stateNames.forEach( row => {
          idToState[row.id] = row.name;
        });

        let stateToCode = {} 
        stateNames.forEach( row => {
          stateToCode[row.name] = row.code;
        });

        let fipsToPop = {} 
        pop.forEach( row => {
          fipsToPop[row.FIPS] = row.POP_2019;
        });

        let fipsToCounty = {} 
        pop.forEach( row => {
          fipsToCounty[row.FIPS] = row.Area_Name;
        });

        let countyToCrime = {} 
        let crimeRange = []
        crime.forEach( row => {
          countyToCrime[row.County] = row.total_crime;
          crimeRange.push(row.total_crime);
        });

        let countyToPolice = {} 
        let policeRange = []
        police.forEach( row => {
          countyToPolice[row.County] = row.Total_law;
          policeRange.push(row.Total_law);
        });

        //------------------------------------------------------------------//
        const count = await d3.json("../counties-10m.json");
    
        var counties = topojson.feature(count, count.objects.counties);
        
        //counties.features is a list of dictionaries
        //change it so that it is a dictionary mapping state to the list of dictionary counties
        const countyDictionary = {}
        for(var i = 0; i < stateNames.length; i++){
          countyDictionary[stateNames[i]['code']] =[]
        }
    
        for(var i = 0; i < counties.features.length; i++){
          for(var j = 0; j < fipsCode.length; j++){
            if(fipsCode[j]['STCOUNTYFP'] == parseInt(counties.features[i].id)){
              var newList = countyDictionary[fipsCode[j]['STATE']]
              newList.push(counties.features[i])
              countyDictionary[fipsCode[j]['STATE']] = newList
            }

          }
        }        
  
    d3.selectAll(".state").on("click", displayState);

    let colorMatrix = [ ["#e8e8e8", "#ace4e4", "#5ac8c8"],
                        ["#dfb0d6", "#a5add3", "#5698b9"],
                        ["#be64ac", "#8c62aa", "#3b4994"] ];


    let crimeScale = d3.scaleQuantile().domain(crimeRange).range([0,1,2]);   
    let policingScale = d3.scaleQuantile().domain(policeRange).range([0,1,2]);
  
    function displayState() {
      let state = d3.select(this);
      let stateID = state.datum().id;
      var stateAbr = stateToCode[idToState[stateID]];

  
      var projection = d3.geoMercator().fitSize([obmapWidth, obmapHeight], {type: "FeatureCollection", features: countyDictionary[stateAbr]});
      var path = d3.geoPath().projection(projection);
      ffmap.selectAll("path.health").data(countyDictionary[stateAbr])
            .join("path")
            .attr("class","county")
            .attr("d", path)
            .attr("fill", d => { 
              console.log(d)
                  let crimeIndex = crimeScale(countyToCrime[d.properties.name]);
                  let policeIndex = policingScale(countyToPolice[d.properties.name]);
                  if (crimeIndex === undefined | policeIndex === undefined) {
                      return "";  // No fill
                  }
                  else {
                    return colorMatrix[ crimeIndex ][ policeIndex ];
            };})

      d3.selectAll(".county").on("click", countyHover);

      function countyHover() {
        let county = d3.select(this);
        let fipsID = county.datum().id;
        console.log(fipsToCounty[fipsID], fipsToPop[fipsID]);
      }
    }

    

        
     

      };
      requestData();
    
    
      </script>
    
    
    
    
      </div>
    </body>
    </html>
    